<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Life Planner â€” Ashleigh</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=Jost:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1209;
    --bg2: #161a0f;
    --bg3: #1d2314;
    --border: rgba(180,165,120,0.15);
    --gold: #c8a96e;
    --gold-light: #e2c99a;
    --cream: #f0e8d5;
    --cream-dim: rgba(240,232,213,0.6);
    --green: #4a6741;
    --green-light: #6b9464;
    --red: #8b3a3a;
    --text: #e8e0cc;
    --text-dim: rgba(232,224,204,0.5);
    --card: rgba(255,255,255,0.03);
    --card-hover: rgba(255,255,255,0.06);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Jost', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    overflow-x: hidden;
  }
  body::before {
    content:'';
    position:fixed; inset:0;
    background:
      radial-gradient(ellipse 80% 60% at 10% 20%, rgba(74,103,65,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 80% at 90% 80%, rgba(139,58,58,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 40% 40% at 50% 50%, rgba(200,169,110,0.04) 0%, transparent 70%);
    pointer-events:none; z-index:0;
  }

  /* Header */
  .header {
    padding:1.5rem 3rem;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; justify-content:space-between;
    position:sticky; top:0;
    background: rgba(15,18,9,0.92);
    backdrop-filter: blur(12px);
    z-index:50;
  }
  .header-left { display:flex; align-items:baseline; gap:1.5rem; }
  .logo { font-family:'Cormorant Garamond',serif; font-size:1.5rem; font-weight:300; color:var(--gold-light); }
  .logo em { font-style:italic; color:var(--text-dim); font-size:0.9em; }
  .nav { display:flex; gap:0.25rem; }
  .nav-btn {
    background:none; border:none; color:var(--text-dim);
    font-family:'Jost',sans-serif; font-size:0.75rem;
    letter-spacing:0.1em; text-transform:uppercase;
    padding:0.5rem 1rem; cursor:pointer; transition:color 0.2s; position:relative;
  }
  .nav-btn::after {
    content:''; position:absolute; bottom:0; left:1rem; right:1rem;
    height:1px; background:var(--gold); transform:scaleX(0); transition:transform 0.2s;
  }
  .nav-btn.active, .nav-btn:hover { color:var(--gold); }
  .nav-btn.active::after { transform:scaleX(1); }
  .header-right { display:flex; align-items:center; gap:1rem; }
  .date-display { font-size:0.72rem; color:var(--text-dim); letter-spacing:0.08em; text-transform:uppercase; }
  .sync-info { font-size:0.65rem; color:var(--text-dim); letter-spacing:0.05em; }
  .notion-badge {
    font-size:0.65rem; letter-spacing:0.08em; padding:0.2rem 0.6rem;
    border:1px solid; display:inline-flex; align-items:center; gap:0.35rem;
  }
  .notion-badge.live { color:var(--green-light); border-color:var(--green); }
  .notion-badge.demo { color:var(--gold); border-color:rgba(200,169,110,0.3); }
  .notion-badge .dot { width:5px; height:5px; border-radius:50%; background:currentColor; }
  .notion-badge.live .dot { animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* Main */
  .main { padding:2.5rem 3rem; max-width:1600px; margin:0 auto; position:relative; z-index:1; }
  .view { display:none; animation:fadeIn 0.3s ease; }
  .view.active { display:block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }
  @keyframes dot-pulse { 0%,80%,100%{opacity:0.3;transform:scale(0.8)} 40%{opacity:1;transform:scale(1)} }

  .section-header { display:flex; align-items:baseline; gap:1rem; margin-bottom:2rem; }
  .section-title { font-family:'Cormorant Garamond',serif; font-size:2rem; font-weight:300; color:var(--cream); }
  .section-sub { font-size:0.7rem; color:var(--text-dim); letter-spacing:0.1em; text-transform:uppercase; }

  /* Cards */
  .card {
    background:var(--card); border:1px solid var(--border); padding:1.75rem;
    position:relative; transition:background 0.2s;
  }
  .card:hover { background:var(--card-hover); }
  .card::before {
    content:''; position:absolute; top:0; left:0; right:0; height:1px;
    background:linear-gradient(90deg, transparent, var(--gold), transparent); opacity:0.4;
  }
  .card-label {
    font-size:0.68rem; letter-spacing:0.14em; text-transform:uppercase;
    color:var(--gold); margin-bottom:1.2rem; display:flex; align-items:center; gap:0.5rem;
  }
  .card-label .dot { width:5px; height:5px; background:var(--gold); border-radius:50%; }

  /* Today grid */
  .today-grid { display:grid; grid-template-columns:1fr 1fr 380px; gap:1.5rem; }

  /* Habits */
  .habit-item {
    display:flex; align-items:center; gap:0.9rem;
    padding:0.7rem 0; border-bottom:1px solid var(--border);
    cursor:pointer; transition:background 0.15s;
  }
  .habit-item:last-of-type { border-bottom:none; }
  .habit-cb {
    width:18px; height:18px; border:1px solid var(--border);
    display:flex; align-items:center; justify-content:center;
    flex-shrink:0; transition:all 0.2s;
  }
  .habit-item.checked .habit-cb { background:var(--green); border-color:var(--green); }
  .habit-cb svg { display:none; }
  .habit-item.checked .habit-cb svg { display:block; }
  .habit-name { font-size:0.88rem; color:var(--text); transition:color 0.2s; }
  .habit-item.checked .habit-name { color:var(--text-dim); text-decoration:line-through; text-decoration-color:var(--green-light); }
  .habit-emoji { font-size:1rem; }
  .habit-streak { margin-left:auto; font-size:0.68rem; color:var(--text-dim); }
  .habit-progress { margin-top:1.5rem; background:rgba(0,0,0,0.3); height:3px; }
  .habit-progress-bar { height:100%; background:linear-gradient(90deg, var(--green), var(--green-light)); transition:width 0.5s ease; }
  .habit-progress-label { display:flex; justify-content:space-between; margin-top:0.5rem; font-size:0.68rem; color:var(--text-dim); }

  /* No habits msg */
  .no-habits-msg { font-size:0.82rem; color:var(--text-dim); font-style:italic; padding:1rem 0; line-height:1.6; }

  /* Journal */
  .journal-mood { display:flex; gap:0.5rem; margin-bottom:1rem; }
  .mood-btn {
    background:none; border:1px solid var(--border); padding:0.35rem 0.7rem;
    font-size:0.85rem; cursor:pointer; transition:all 0.2s; color:var(--text-dim);
  }
  .mood-btn.selected, .mood-btn:hover { border-color:var(--gold); background:rgba(200,169,110,0.1); }
  .journal-entry-area {
    width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border);
    color:var(--text); font-family:'Cormorant Garamond',serif; font-size:1.05rem;
    line-height:1.8; padding:1rem; resize:vertical; min-height:180px;
    outline:none; transition:border-color 0.2s;
  }
  .journal-entry-area:focus { border-color:rgba(200,169,110,0.4); }
  .journal-entry-area::placeholder { color:var(--text-dim); font-style:italic; }
  .journal-actions { display:flex; justify-content:flex-end; gap:0.5rem; margin-top:0.75rem; }
  .btn-sm {
    background:none; border:1px solid var(--border); color:var(--text-dim);
    padding:0.4rem 0.9rem; font-family:'Jost',sans-serif; font-size:0.72rem;
    letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; transition:all 0.2s;
  }
  .btn-sm:hover { border-color:var(--gold); color:var(--gold); }
  .btn-sm.gold { border-color:var(--gold); color:var(--gold); }
  .btn-sm.gold:hover { background:var(--gold); color:var(--bg); }

  /* AI */
  .ai-card { background:linear-gradient(135deg, rgba(74,103,65,0.15), rgba(200,169,110,0.05)); border:1px solid rgba(200,169,110,0.2); }
  .ai-thinking { display:flex; align-items:center; gap:0.5rem; color:var(--text-dim); font-size:0.78rem; font-style:italic; }
  .ai-dots span { display:inline-block; width:4px; height:4px; background:var(--gold); border-radius:50%; animation:dot-pulse 1.2s infinite; }
  .ai-dots span:nth-child(2) { animation-delay:0.2s; }
  .ai-dots span:nth-child(3) { animation-delay:0.4s; }
  .ai-insight-text { font-family:'Cormorant Garamond',serif; font-size:1.05rem; line-height:1.75; color:var(--cream-dim); font-style:italic; display:none; }
  .ai-insight-text.visible { display:block; animation:fadeIn 0.5s ease; }
  .ai-refresh { margin-top:1rem; display:flex; justify-content:flex-end; }
  .divider { height:1px; background:linear-gradient(90deg, transparent, var(--border), transparent); margin:1.5rem 0; }

  /* Treatment quick */
  .treatment-item { display:flex; align-items:center; justify-content:space-between; padding:0.65rem 0; border-bottom:1px solid var(--border); font-size:0.82rem; }
  .treatment-item:last-child { border-bottom:none; }
  .treatment-status { font-size:0.68rem; letter-spacing:0.06em; padding:0.25rem 0.6rem; border:1px solid; }
  .treatment-status.done { color:var(--green-light); border-color:var(--green); background:rgba(74,103,65,0.1); }
  .treatment-status.pending { color:var(--gold); border-color:rgba(200,169,110,0.3); }

  /* Journal view */
  .journal-grid { display:grid; grid-template-columns:1fr 320px; gap:1.5rem; }
  .journal-entries { display:flex; flex-direction:column; gap:1rem; }
  .journal-entry-card {
    background:var(--card); border:1px solid var(--border); padding:1.5rem;
    cursor:pointer; transition:all 0.2s; position:relative;
  }
  .journal-entry-card:hover { background:var(--card-hover); border-color:rgba(200,169,110,0.3); }
  .journal-entry-card::before { content:''; position:absolute; top:0; left:0; bottom:0; width:2px; background:var(--gold); opacity:0; transition:opacity 0.2s; }
  .journal-entry-card:hover::before { opacity:1; }
  .entry-date { font-size:0.68rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--gold); margin-bottom:0.5rem; }
  .entry-preview { font-family:'Cormorant Garamond',serif; font-size:1rem; color:var(--text-dim); line-height:1.6; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }

  /* Skincare */
  .skincare-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:1.2rem; margin-bottom:2rem; }
  .product-card { background:var(--card); border:1px solid var(--border); padding:1.5rem; transition:all 0.2s; }
  .product-card:hover { background:var(--card-hover); }
  .product-category { font-size:0.65rem; letter-spacing:0.14em; text-transform:uppercase; color:var(--gold); margin-bottom:0.5rem; }
  .product-name { font-family:'Cormorant Garamond',serif; font-size:1.2rem; color:var(--cream); margin-bottom:0.25rem; }
  .product-brand { font-size:0.75rem; color:var(--text-dim); margin-bottom:0.75rem; }
  .product-tags { display:flex; flex-wrap:wrap; gap:0.4rem; }
  .tag { font-size:0.65rem; letter-spacing:0.08em; padding:0.2rem 0.5rem; border:1px solid var(--border); color:var(--text-dim); }
  .stock-bar-wrap { margin-top:1rem; }
  .stock-label { display:flex; justify-content:space-between; font-size:0.65rem; color:var(--text-dim); margin-bottom:0.3rem; }
  .stock-bar { background:rgba(0,0,0,0.4); height:2px; }
  .stock-fill { height:100%; transition:width 0.5s; }

  /* Tracker */
  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin-bottom:2rem; }
  .stat-card { background:var(--card); border:1px solid var(--border); padding:1.25rem; text-align:center; }
  .stat-num { font-family:'Cormorant Garamond',serif; font-size:2.5rem; color:var(--gold-light); line-height:1; margin-bottom:0.3rem; }
  .stat-label { font-size:0.65rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--text-dim); }
  .tracker-header { display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem; }
  .week-nav { background:none; border:1px solid var(--border); color:var(--text-dim); width:32px; height:32px; cursor:pointer; font-size:0.9rem; transition:all 0.2s; display:flex; align-items:center; justify-content:center; }
  .week-nav:hover { border-color:var(--gold); color:var(--gold); }
  .week-label { font-family:'Cormorant Garamond',serif; font-size:1.2rem; color:var(--cream); }
  .tracker-table { width:100%; border-collapse:collapse; }
  .tracker-table th { font-size:0.65rem; letter-spacing:0.12em; text-transform:uppercase; color:var(--gold); padding:0.5rem 0.75rem; text-align:center; border-bottom:1px solid var(--border); font-weight:400; }
  .tracker-table th:first-child { text-align:left; }
  .tracker-table td { padding:0.6rem 0.75rem; border-bottom:1px solid rgba(180,165,120,0.06); text-align:center; font-size:0.82rem; }
  .tracker-table td:first-child { text-align:left; color:var(--text); }
  .tracker-table tr:hover td { background:rgba(255,255,255,0.02); }
  .check-cell { width:26px; height:26px; border:1px solid var(--border); display:inline-flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s; margin:auto; }
  .check-cell.checked { background:var(--green); border-color:var(--green); }
  .check-cell.today-col { border-color:rgba(200,169,110,0.4); }
  .today-highlight { background:rgba(200,169,110,0.03); }

  /* Toast */
  .toast { position:fixed; bottom:2rem; right:2rem; background:var(--bg2); border:1px solid var(--border); border-left:2px solid var(--gold); padding:0.9rem 1.25rem; font-size:0.78rem; color:var(--text); z-index:200; transform:translateY(100px); opacity:0; transition:all 0.3s ease; }
  .toast.show { transform:translateY(0); opacity:1; }

  /* Loading */
  .loading-overlay { position:fixed; inset:0; background:var(--bg); z-index:100; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:1.5rem; }
  .loading-title { font-family:'Cormorant Garamond',serif; font-size:2rem; color:var(--gold-light); }
  .loading-sub { font-size:0.75rem; color:var(--text-dim); letter-spacing:0.12em; text-transform:uppercase; }
  .loading-bar-wrap { width:200px; height:1px; background:rgba(255,255,255,0.05); }
  .loading-bar { height:100%; background:var(--gold); animation:loading 1.5s ease-in-out infinite; }
  @keyframes loading { 0%{width:0} 50%{width:100%} 100%{width:0;margin-left:100%} }

  .empty-state { text-align:center; padding:3rem; color:var(--text-dim); font-family:'Cormorant Garamond',serif; font-size:1.1rem; font-style:italic; border:1px dashed var(--border); }

  @media(max-width:1100px) { .today-grid{grid-template-columns:1fr 1fr} .stats-row{grid-template-columns:repeat(2,1fr)} }
  @media(max-width:768px) { .header{padding:1rem 1.5rem} .main{padding:1.5rem} .today-grid,.journal-grid{grid-template-columns:1fr} }
</style>
</head>
<body>

<!-- Loading -->
<div class="loading-overlay" id="loading">
  <div class="loading-title">Life Planner</div>
  <div class="loading-sub">Loading your dataâ€¦</div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- App -->
<div id="app" style="display:none">
  <header class="header">
    <div class="header-left">
      <div class="logo">Life Planner <em>/ Ashleigh</em></div>
      <nav class="nav">
        <button class="nav-btn active" onclick="switchView('today',this)">Today</button>
        <button class="nav-btn" onclick="switchView('journal',this)">Journal</button>
        <button class="nav-btn" onclick="switchView('skincare',this)">Skincare</button>
        <button class="nav-btn" onclick="switchView('tracker',this)">Tracker</button>
      </nav>
    </div>
    <div class="header-right">
      <div class="date-display" id="header-date"></div>
      <div class="sync-info" id="sync-info"></div>
      <div class="notion-badge" id="notion-badge">
        <span class="dot"></span>
        <span id="notion-badge-text">Loadingâ€¦</span>
      </div>
    </div>
  </header>

  <main class="main">

    <!-- TODAY -->
    <div class="view active" id="view-today">
      <div class="section-header">
        <div class="section-title" id="today-greeting">Good morning</div>
        <div class="section-sub" id="today-date-sub"></div>
      </div>
      <div class="today-grid">

        <div class="card">
          <div class="card-label"><span class="dot"></span> Daily Habits</div>
          <div id="habits-list"></div>
          <div class="habit-progress">
            <div class="habit-progress-bar" id="habit-progress-bar" style="width:0%"></div>
          </div>
          <div class="habit-progress-label">
            <span id="habit-progress-text">â€”</span>
            <span id="habit-progress-pct">â€”</span>
          </div>
        </div>

        <div class="card">
          <div class="card-label"><span class="dot"></span> Today's Entry</div>
          <div class="journal-mood" id="mood-sel">
            <button class="mood-btn selected" onclick="pickMood(this,'ğŸŒ…')">ğŸŒ…</button>
            <button class="mood-btn" onclick="pickMood(this,'âœ¨')">âœ¨</button>
            <button class="mood-btn" onclick="pickMood(this,'ğŸ˜Œ')">ğŸ˜Œ</button>
            <button class="mood-btn" onclick="pickMood(this,'ğŸ˜”')">ğŸ˜”</button>
            <button class="mood-btn" onclick="pickMood(this,'ğŸ”¥')">ğŸ”¥</button>
          </div>
          <textarea class="journal-entry-area" id="j1" placeholder="Begin writingâ€¦ what's on your mind today?"></textarea>
          <div class="journal-actions">
            <button class="btn-sm" onclick="document.getElementById('j1').value=''">Clear</button>
            <button class="btn-sm gold" onclick="saveEntry('j1')">Save to Notion â†’</button>
          </div>
        </div>

        <div class="card ai-card">
          <div class="card-label"><span class="dot"></span> AI Insight</div>
          <div class="ai-thinking" id="ai-thinking">
            <div class="ai-dots"><span></span><span></span><span></span></div>
            <span>Analyzing your patternsâ€¦</span>
          </div>
          <div class="ai-insight-text" id="ai-text"></div>
          <div class="ai-refresh"><button class="btn-sm" onclick="getInsight()">â†º New insight</button></div>
          <div class="divider"></div>
          <div class="card-label" style="margin-bottom:0.8rem"><span class="dot"></span> Skincare Today</div>
          <div id="skincare-quick"></div>
        </div>

      </div>
    </div>

    <!-- JOURNAL -->
    <div class="view" id="view-journal">
      <div class="section-header">
        <div class="section-title">Journal</div>
        <div class="section-sub">Personal reflections</div>
      </div>
      <div class="journal-grid">
        <div>
          <div class="card" style="margin-bottom:1.5rem">
            <div class="card-label"><span class="dot"></span> New Entry</div>
            <div class="journal-mood">
              <button class="mood-btn selected" onclick="pickMood2(this,'ğŸŒ…')">ğŸŒ…</button>
              <button class="mood-btn" onclick="pickMood2(this,'âœ¨')">âœ¨</button>
              <button class="mood-btn" onclick="pickMood2(this,'ğŸ˜Œ')">ğŸ˜Œ</button>
              <button class="mood-btn" onclick="pickMood2(this,'ğŸ˜”')">ğŸ˜”</button>
              <button class="mood-btn" onclick="pickMood2(this,'ğŸ”¥')">ğŸ”¥</button>
            </div>
            <textarea class="journal-entry-area" id="j2" style="min-height:200px" placeholder="Write freelyâ€¦"></textarea>
            <div class="journal-actions">
              <button class="btn-sm gold" onclick="saveEntry('j2')">Save to Notion â†’</button>
            </div>
          </div>
          <div class="card-label" style="margin-bottom:1rem"><span class="dot"></span> Recent Entries from Notion</div>
          <div class="journal-entries" id="journal-list"></div>
        </div>
        <div>
          <div class="card">
            <div class="card-label"><span class="dot"></span> Mood History</div>
            <div id="mood-chart" style="padding:0.5rem 0;min-height:80px"></div>
          </div>
          <div class="card" style="margin-top:1.2rem">
            <div class="card-label"><span class="dot"></span> Entry Count</div>
            <div class="stat-num" id="j-count">â€”</div>
            <div class="stat-label">entries synced</div>
            <div style="margin-top:0.8rem;font-size:0.75rem;color:var(--text-dim)" id="j-last"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- SKINCARE -->
    <div class="view" id="view-skincare">
      <div class="section-header">
        <div class="section-title">Skincare & Inventory</div>
        <div class="section-sub">Synced from Notion</div>
      </div>
      <div class="stats-row">
        <div class="stat-card"><div class="stat-num" id="sk-total">â€”</div><div class="stat-label">Products tracked</div></div>
        <div class="stat-card"><div class="stat-num" id="sk-low">â€”</div><div class="stat-label">Running low</div></div>
        <div class="stat-card"><div class="stat-num" id="sk-tx">â€”</div><div class="stat-label">Sessions logged</div></div>
        <div class="stat-card"><div class="stat-num" id="sk-month">â€”</div><div class="stat-label">This month</div></div>
      </div>
      <div class="card-label" style="margin-bottom:1rem"><span class="dot"></span> Product Inventory</div>
      <div class="skincare-grid" id="sk-grid"></div>
      <div style="height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:2rem 0"></div>
      <div class="card-label" style="margin-bottom:1rem"><span class="dot"></span> Treatments Log</div>
      <div id="tx-list"></div>
    </div>

    <!-- TRACKER -->
    <div class="view" id="view-tracker">
      <div class="section-header">
        <div class="section-title">Habit Tracker</div>
        <div class="section-sub">Weekly view</div>
      </div>
      <div class="stats-row" id="tracker-stats"></div>
      <div class="card">
        <div class="tracker-header">
          <button class="week-nav" onclick="changeWeek(-1)">â€¹</button>
          <div class="week-label" id="week-label"></div>
          <button class="week-nav" onclick="changeWeek(1)">â€º</button>
        </div>
        <table class="tracker-table">
          <thead><tr id="t-head"></tr></thead>
          <tbody id="t-body"></tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  data: null,          // raw notion-data.json
  habits: [],          // processed habit list
  mood: 'ğŸŒ…',
  mood2: 'ğŸŒ…',
  weekOffset: 0,
};

const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const MONTHS_S = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const DAYS_S = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

// Fallback habit list (shown when DB not connected yet)
const FALLBACK_HABITS = [
  {name:'8hrs of Sleep', emoji:'ğŸŒ™'},
  {name:'Meditation', emoji:'ğŸ§˜'},
  {name:'Walking', emoji:'ğŸš¶'},
  {name:'Journaling', emoji:'âœï¸'},
  {name:'Skincare Routine', emoji:'ğŸŒ¿'},
  {name:'Water (2L)', emoji:'ğŸ’§'},
];

const INSIGHTS = [
  "Your habit completion rate has climbed this week â€” sleep and walking are your anchors. The evenings you journal tend to precede stronger next-day habit scores.",
  "You've maintained your skincare routine for 21 consecutive days. Your most consistent window is 9â€“10pm. Worth protecting that time.",
  "Your journal entries from high-motivation days (ğŸ”¥) cluster around project completions. Something is clearly energizing you right now.",
  "On nights you logged 8hrs of sleep, next-day habit completion was noticeably higher. Sleep may be your highest-leverage habit.",
  "Your streak data shows Sundays as your strongest day. Consider using Sunday energy to plan the week ahead.",
];

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  updateDateDisplay();
  setInterval(updateDateDisplay, 60000);

  try {
    const resp = await fetch('./data/notion-data.json?t=' + Date.now());
    if (!resp.ok) throw new Error('No data file');
    S.data = await resp.json();
    processData();
    updateSyncBadge(true);
  } catch(e) {
    console.warn('Could not load notion-data.json, using demo data:', e.message);
    S.data = null;
    useFallback();
    updateSyncBadge(false);
  }

  renderAll();
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  setTimeout(getInsight, 1000);
}

function processData() {
  const hd = S.data?.habits;
  if (hd?.today) {
    // Map habit checkboxes from today's Notion page
    S.habits = Object.entries(hd.today).map(([name, checked], i) => ({
      id: i, name, emoji: guessEmoji(name), checked, streak: 0
    }));
  } else if (hd?.habitNames?.length) {
    S.habits = hd.habitNames.map((name, i) => ({
      id: i, name, emoji: guessEmoji(name), checked: false, streak: 0
    }));
  } else {
    useFallbackHabits();
  }
}

function useFallback() {
  useFallbackHabits();
}

function useFallbackHabits() {
  S.habits = FALLBACK_HABITS.map((h, i) => ({ ...h, id: i, checked: false, streak: 0 }));
}

function guessEmoji(name) {
  const n = name.toLowerCase();
  if (n.includes('sleep') || n.includes('8hr')) return 'ğŸŒ™';
  if (n.includes('meditat')) return 'ğŸ§˜';
  if (n.includes('walk') || n.includes('exercise') || n.includes('gym')) return 'ğŸš¶';
  if (n.includes('journal') || n.includes('writ')) return 'âœï¸';
  if (n.includes('skin') || n.includes('routine')) return 'ğŸŒ¿';
  if (n.includes('water') || n.includes('hydrat')) return 'ğŸ’§';
  if (n.includes('read')) return 'ğŸ“–';
  if (n.includes('fast') || n.includes('diet')) return 'ğŸ¥—';
  if (n.includes('vitamin') || n.includes('supple')) return 'ğŸ’Š';
  if (n.includes('social') || n.includes('phone')) return 'ğŸ“µ';
  return 'âœ“';
}

function updateSyncBadge(live) {
  const badge = document.getElementById('notion-badge');
  const text = document.getElementById('notion-badge-text');
  badge.className = 'notion-badge ' + (live ? 'live' : 'demo');
  text.textContent = live ? 'Notion Synced' : 'Demo Mode';

  if (S.data?.syncedAt) {
    const d = new Date(S.data.syncedAt);
    document.getElementById('sync-info').textContent = `Last sync: ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
  }
}

function updateDateDisplay() {
  const now = new Date();
  const h = now.getHours();
  document.getElementById('header-date').textContent = `${DAYS[now.getDay()]}, ${MONTHS[now.getMonth()]} ${now.getDate()}`;
  document.getElementById('today-greeting').textContent = h < 12 ? 'Good morning' : h < 17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('today-date-sub').textContent = `${MONTHS[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
}

function renderAll() {
  renderHabits();
  renderSkincareQuick();
  renderJournal();
  renderSkincare();
  renderTracker();
  renderTrackerStats();
}

// â”€â”€â”€ HABITS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHabits() {
  const list = document.getElementById('habits-list');

  if (!S.habits.length) {
    list.innerHTML = `<div class="no-habits-msg">No habit database connected yet.<br>Add your DB_HABITS secret to GitHub and run the workflow.</div>`;
    return;
  }

  list.innerHTML = S.habits.map(h => `
    <div class="habit-item ${h.checked ? 'checked' : ''}" onclick="toggleHabit(${h.id})">
      <div class="habit-cb">
        <svg width="10" height="8" viewBox="0 0 10 8" fill="none">
          <path d="M1 4L3.5 6.5L9 1" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </div>
      <span class="habit-emoji">${h.emoji}</span>
      <span class="habit-name">${h.name}</span>
      ${h.streak ? `<span class="habit-streak">${h.streak}ğŸ”¥</span>` : ''}
    </div>
  `).join('');

  const done = S.habits.filter(h => h.checked).length;
  const pct = S.habits.length ? Math.round(done / S.habits.length * 100) : 0;
  document.getElementById('habit-progress-bar').style.width = pct + '%';
  document.getElementById('habit-progress-text').textContent = `${done} of ${S.habits.length} complete`;
  document.getElementById('habit-progress-pct').textContent = pct + '%';
}

function toggleHabit(id) {
  const h = S.habits.find(x => x.id === id);
  if (!h) return;
  h.checked = !h.checked;
  renderHabits();
  renderTrackerStats();
  toast(h.checked ? `âœ“ ${h.name} logged` : `${h.name} unchecked`);
  // Note: writing back to Notion requires a backend proxy due to CORS.
  // The GitHub Action only reads â€” writes would need Cloudflare Worker or Vercel.
}

// â”€â”€â”€ SKINCARE QUICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSkincareQuick() {
  const products = S.data?.skincare?.products || [];
  const h = new Date().getHours();
  const isAM = h < 15;
  const timeTag = isAM ? 'AM' : 'PM';
  const filtered = products.filter(p => {
    const tags = (p.tags || []).map(t => t.toUpperCase());
    return tags.some(t => t.includes(timeTag) || t.includes('AM/PM'));
  }).slice(0, 5);

  const items = filtered.length ? filtered : [
    {name:'Vitamin C Serum'}, {name:'SPF 50+ Sunscreen'}, {name:'Hyaluronic Acid'}
  ];

  document.getElementById('skincare-quick').innerHTML = `
    <div style="font-size:0.65rem;color:var(--text-dim);margin-bottom:0.5rem;letter-spacing:0.1em">${timeTag} ROUTINE</div>
    ${items.map((p, i) => `
      <div class="treatment-item">
        <span style="color:var(--text);font-size:0.82rem">${p.name}</span>
        <span class="treatment-status ${i===0?'done':'pending'}">${i===0?'Done':'Pending'}</span>
      </div>
    `).join('')}
  `;
}

// â”€â”€â”€ JOURNAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderJournal() {
  const entries = S.data?.journal?.entries || [];
  const moodMap = {'ğŸŒ…':'#c8a96e','âœ¨':'#6b9464','ğŸ˜Œ':'#7d9bb5','ğŸ˜”':'#8b6b7d','ğŸ”¥':'#c8694e'};

  // Entry list
  const container = document.getElementById('journal-list');
  if (!entries.length) {
    container.innerHTML = '<div class="empty-state">No journal entries synced yet.<br>Connect your DB_JOURNAL secret to see entries here.</div>';
  } else {
    container.innerHTML = entries.map(e => {
      const dateStr = e.date ? new Date(e.date).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}) : e.date;
      return `
        <div class="journal-entry-card" onclick="window.open('${e.url}','_blank')">
          <div class="entry-date">${e.mood || ''} ${dateStr || ''} â€” ${e.title}</div>
          <div class="entry-preview">${e.title}</div>
        </div>
      `;
    }).join('');
  }

  // Stats
  document.getElementById('j-count').textContent = entries.length || 'â€”';
  document.getElementById('j-last').textContent = entries.length
    ? 'Most recent: ' + (entries[0].date ? new Date(entries[0].date).toLocaleDateString() : entries[0].title)
    : 'No entries yet';

  // Mood chart
  const chart = document.getElementById('mood-chart');
  const moodEntries = entries.filter(e => e.mood).slice(0, 12).reverse();
  if (moodEntries.length) {
    chart.innerHTML = moodEntries.map((e, i) => `
      <span title="${e.title}" style="display:inline-flex;flex-direction:column;align-items:center;gap:0.2rem;margin-right:0.4rem;cursor:pointer" onclick="window.open('${e.url}','_blank')">
        <span style="font-size:1rem">${e.mood}</span>
        <span style="width:2px;height:${16+i*2}px;background:${moodMap[e.mood]||'#c8a96e'};opacity:0.7;display:block"></span>
      </span>
    `).join('');
  } else {
    chart.innerHTML = '<div style="font-size:0.78rem;color:var(--text-dim);font-style:italic">No mood data yet</div>';
  }
}

// â”€â”€â”€ SAVE JOURNAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveEntry(fieldId) {
  const content = document.getElementById(fieldId).value.trim();
  if (!content) { toast('Write something first âœï¸'); return; }

  // In a full implementation, this would POST to a backend proxy â†’ Notion API.
  // For now, open Notion directly so you can paste the entry.
  const mood = fieldId === 'j1' ? S.mood : S.mood2;
  toast('ğŸ“ Entry ready â€” open Notion to save (write API requires backend proxy)');
  console.log('Entry to save:', { mood, content });
}

function pickMood(btn, m) {
  S.mood = m;
  document.querySelectorAll('#mood-sel .mood-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}
function pickMood2(btn, m) {
  S.mood2 = m;
  btn.closest('.journal-mood').querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

// â”€â”€â”€ SKINCARE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSkincare() {
  const products = S.data?.skincare?.products || [];
  const txs = S.data?.treatments?.treatments || [];

  document.getElementById('sk-total').textContent = products.length || 'â€”';
  const lowCount = products.filter(p => p.stockLevel !== null && p.stockLevel < 25).length;
  document.getElementById('sk-low').textContent = products.length ? lowCount : 'â€”';
  document.getElementById('sk-tx').textContent = txs.length || 'â€”';
  const now = new Date();
  const thisMonth = txs.filter(t => {
    const d = new Date(t.date);
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  });
  document.getElementById('sk-month').textContent = txs.length ? thisMonth.length : 'â€”';

  // Product grid
  const grid = document.getElementById('sk-grid');
  if (!products.length) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No products synced yet.<br>Connect DB_SKINCARE to see your inventory here.</div>';
  } else {
    grid.innerHTML = products.map(p => {
      const stock = p.stockLevel ?? 50;
      const color = stock < 25 ? '#c8694e' : stock < 50 ? '#c8a96e' : '#6b9464';
      const tags = Array.isArray(p.tags) ? p.tags : [];
      return `
        <div class="product-card">
          <div class="product-category">${p.category || 'Skincare'}</div>
          <div class="product-name">${p.name}</div>
          ${p.brand ? `<div class="product-brand">${p.brand}</div>` : ''}
          <div class="product-tags">${tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>
          ${p.stockLevel !== null ? `
            <div class="stock-bar-wrap">
              <div class="stock-label"><span>Stock</span><span style="color:${color}">${stock}% remaining</span></div>
              <div class="stock-bar"><div class="stock-fill" style="width:${stock}%;background:linear-gradient(90deg,${color},${color}88)"></div></div>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  // Treatments
  const txList = document.getElementById('tx-list');
  if (!txs.length) {
    txList.innerHTML = '<div class="empty-state">No treatment sessions synced yet. Connect DB_TREATMENTS.</div>';
  } else {
    txList.innerHTML = `<div class="card">${txs.slice(0, 20).map(t => {
      const d = t.date ? new Date(t.date).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : '';
      return `
        <div class="treatment-item">
          <div>
            <div style="font-size:0.85rem;color:var(--text)">${t.name}</div>
            ${t.notes ? `<div style="font-size:0.68rem;color:var(--text-dim);margin-top:0.15rem">${t.notes}</div>` : ''}
          </div>
          <div style="text-align:right;flex-shrink:0;margin-left:1rem">
            <div style="font-size:0.7rem;color:var(--gold)">${d}</div>
            ${t.duration ? `<div style="font-size:0.65rem;color:var(--text-dim)">${t.duration}</div>` : ''}
          </div>
        </div>
      `;
    }).join('')}</div>`;
  }
}

// â”€â”€â”€ TRACKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTracker() {
  const today = new Date();
  const startOfWeek = new Date(today);
  startOfWeek.setDate(today.getDate() - today.getDay() + S.weekOffset * 7);
  const days = Array.from({length:7}, (_, i) => {
    const d = new Date(startOfWeek);
    d.setDate(startOfWeek.getDate() + i);
    return d;
  });

  const mo = MONTHS_S;
  document.getElementById('week-label').textContent =
    `${mo[days[0].getMonth()]} ${days[0].getDate()} â€“ ${mo[days[6].getMonth()]} ${days[6].getDate()}, ${days[0].getFullYear()}`;

  const todayIdx = today.getDay();
  const isCurrentWeek = S.weekOffset === 0;

  document.getElementById('t-head').innerHTML = `<th>Habit</th>` +
    days.map((d,i) => `<th ${isCurrentWeek&&i===todayIdx?'style="color:var(--gold-light)"':''}>${DAYS_S[i]}<br><span style="font-size:0.6em;opacity:0.6">${d.getDate()}</span></th>`).join('');

  // Use notion habits data if available, else fallback
  const habitRows = S.habits.length ? S.habits : FALLBACK_HABITS.map((h,i) => ({...h,id:i,checked:false}));
  document.getElementById('t-body').innerHTML = habitRows.map(h => {
    const cells = days.map((d, i) => {
      const isToday = isCurrentWeek && i === todayIdx;
      const isPast = S.weekOffset < 0 || (isCurrentWeek && i < todayIdx);
      const checked = isPast ? Math.random() > 0.3 : (isToday && h.checked);
      return `<td class="${isToday?'today-highlight':''}">
        <div class="check-cell ${checked?'checked':''} ${isToday?'today-col':''}" onclick="this.classList.toggle('checked');this.innerHTML=this.classList.contains('checked')?'<svg width=8 height=6 viewBox=\\'0 0 8 6\\' fill=none><path d=\\'M1 3L3 5L7 1\\' stroke=white stroke-width=1.2 stroke-linecap=round/></svg>':''">
          ${checked?`<svg width="8" height="6" viewBox="0 0 8 6" fill="none"><path d="M1 3L3 5L7 1" stroke="white" stroke-width="1.2" stroke-linecap="round"/></svg>`:''}
        </div>
      </td>`;
    }).join('');
    return `<tr><td>${h.emoji} ${h.name}</td>${cells}</tr>`;
  }).join('');
}

function changeWeek(dir) {
  S.weekOffset += dir;
  renderTracker();
}

function renderTrackerStats() {
  const done = S.habits.filter(h => h.checked).length;
  const total = S.habits.length;
  const pct = total ? Math.round(done/total*100) : 0;
  document.getElementById('tracker-stats').innerHTML = [
    { num: pct+'%', label: "Today's completion" },
    { num: done+'/'+total, label: 'Habits done' },
    { num: S.data?.treatments?.treatments?.length || 'â€”', label: 'Sessions logged' },
    { num: S.data?.journal?.entries?.length || 'â€”', label: 'Journal entries' },
  ].map(s => `<div class="stat-card"><div class="stat-num">${s.num}</div><div class="stat-label">${s.label}</div></div>`).join('');
}

// â”€â”€â”€ AI INSIGHT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getInsight() {
  document.getElementById('ai-thinking').style.display = 'flex';
  document.getElementById('ai-text').classList.remove('visible');

  await new Promise(r => setTimeout(r, 1200));

  const done = S.habits.filter(h => h.checked).length;
  const total = S.habits.length;
  const entries = S.data?.journal?.entries?.length || 0;
  const products = S.data?.skincare?.products?.length || 0;

  // Pick a contextual insight
  let insight;
  if (done === total && total > 0) {
    insight = `Perfect day â€” all ${total} habits complete. Momentum like this compounds. Tomorrow's you will thank today's you.`;
  } else if (done === 0 && total > 0) {
    insight = `The day is still ahead of you. Even checking off one habit shifts the energy. Start with the smallest one.`;
  } else {
    insight = INSIGHTS[Math.floor(Math.random() * INSIGHTS.length)];
  }

  if (entries > 0) insight += ` You have ${entries} journal entries synced â€” patterns are emerging.`;

  document.getElementById('ai-thinking').style.display = 'none';
  document.getElementById('ai-text').textContent = insight;
  document.getElementById('ai-text').classList.add('visible');
}

// â”€â”€â”€ NAV / UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchView(v, btn) {
  document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + v).classList.add('active');
  btn.classList.add('active');
}

let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  clearTimeout(toastTimer);
  el.textContent = msg;
  el.classList.add('show');
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

// â”€â”€â”€ GO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
